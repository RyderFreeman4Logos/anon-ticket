1a571bf6 chore(repo): add workspace gitignore
Established a baseline `.gitignore` that covers Cargo builds, wasm-pack artifacts, IDE clutter, and local configuration in order to keep future Rust worktree clean despite the current minimal file set. Documented why several project-specific paths (matrix bot configs, proto outputs, drafts) remain untracked so contributors know where to place sensitive data without risking accidental commits. Highlighted the intent to pair every public English log with a private Chinese mirror while keeping the mirror ignored so bi-lingual context is preserved locally without polluting history; future entries should follow the same diary style.
af31d54 docs(todo): seed project roadmap
Outlined a tiered roadmap in `TODO.md` that bridges the high-level blueprint from `drafts/dev.md` with concrete, test-first tasks. Prioritized workspace scaffolding and deterministic environment setup as immediate items so later crates inherit consistent tooling, then layered storage, validation, API, monitor, caching, and observability milestones with explicit testing (sqlx integration, Actix HTTP harnesses, property tests) and documentation requirements (README sections, module docs, architecture notes). The checklist also encodes risk callouts—like trait abstraction churn, RPC availability, and cache DoS potential—to keep future contributors aware while enabling modular backends (SQLite now, Redis/moka later).
2702e1a feat(workspace): bootstrap cargo workspace
Stood up the multi-crate workspace with resolver 2, shared package metadata, and lint/format configs so every crate inherits the same rules. Added placeholder API/monitor binaries plus a domain crate that exposes `workspace_ready_message`, wiring the binaries through it to prove dependencies compile end-to-end. Documented the workspace layout/commands in `README.md`, ticked the Immediate-1 entry in `TODO.md`, and validated the scaffold by running `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` from the root.
dbfc2f0 feat(env): add deterministic config plumbing
Pinned the toolchain via `rust-toolchain.toml`, introduced `.env.example`, and documented the `config/` secrets workflow so every crate consumes the same deterministic environment. Extended the workspace manifest with shared `dotenvy`/`sha3`/`hex`/`thiserror` deps, taught the domain crate to expose `BootstrapConfig`, `ConfigError`, and a SHA3-256 PID fingerprint helper, and updated the API + monitor binaries to call those routines. README now explains the environment setup, TODO reflects Immediate-2 completion, and `.gitignore` shields secrets while `config/README.md` captures expectations. Verified everything with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
1895cbe chore(toolchain): bump rust to 1.91.1
Upgraded the workspace to Rust 1.91.1 via `rust-toolchain.toml` and reflected the change in README so contributors install the latest stable toolchain. Verified compatibility by running `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` on the new release.
6dcb33c feat(storage): add seaorm repository layer
Introduced the trait-based storage contracts in `anon_ticket_domain::storage` (PID/service token newtypes, storage errors, async traits) and wired them into the new `anon_ticket_storage` crate. The SeaORM adapter now runs schema migrations for SQLite/optional Postgres, offers a single `SeaOrmStorage::connect` helper, and ships integration tests that exercise payment claiming, token issuance/revocation, and monitor height persistence. README documents how to toggle between SQLite and Postgres features, and the ShortTerm-3 TODO item is checked off to reflect the completed storage milestone.
a992d88 fix(storage): atomically guard payment claims
Hardened `SeaOrmStorage::claim_payment` so that it performs a single atomic `UPDATE ... WHERE status = 'unclaimed'` before reading back the row, preventing concurrent claimers from double-spending the same PID. Added a regression test that launches two async claimers and asserts only one succeeds, ensuring the guard works under real concurrency. Verified the change with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
da571d8 fix(storage): gate tests per backend feature
Adjusted the `anon_ticket_storage` test suite to respect whichever SeaORM backend feature is enabled: SQLite runs against the in-memory DSN, while Postgres relies on a `TEST_POSTGRES_URL` env var, and unsupported combos skip tests with a clear message. README now explains how to set that env var before using the documented Postgres command. Validated the change with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
02f3e77 feat(domain): add pid validation and token helpers
Introduced `validate_pid`, `PaymentId::parse`, and `derive_service_token` so every crate can enforce the 32-character hex PID contract and derive SHA3-based service tokens consistently. The helpers ship unit tests that check invalid inputs, parsing, and deterministic outputs, plus README guidance encouraging callers to use the new APIs. Also ticked ShortTerm-4 in TODO.md to reflect the completed milestone. Validated via `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
1e76921 chore(domain): format pid validation test
Lightly reformatted the `pid_validation_rejects_invalid_inputs` assertion so the long hex string comparison is multi-line and easier to diff/scan during future edits. No behavior change, but keeps the growing domain helper tests consistent with rustfmt output.
7c44143 fix(storage): make payment insert idempotent
Reworked `SeaOrmStorage::insert_payment` to issue a single `INSERT ... ON CONFLICT DO NOTHING` via `exec_without_returning`, so duplicate PID inserts succeed instead of raising unique constraint errors under concurrent monitor tasks. Added a regression test (`inserting_same_pid_twice_is_ok`) to ensure the helper remains side-effect free when called twice. Validated with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
740fdfd feat(api): add redeem endpoint
Implemented the first Actix-Web surface for `POST /api/v1/redeem`: it validates PID format via the shared domain helpers, atomically claims payments through `SeaOrmStorage`, derives deterministic service tokens, and emits structured JSON success/ error responses (404, 409, etc.). Added an `AppState` wiring to BootstrapConfig + SeaORM in `main`, plus README docs covering request/response contracts. Integration tests now spin up the handler on SQLite to cover invalid PID, missing payment, success, and duplicate claim scenarios. Ran `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
c4a6d8c feat(monitor): implement rpc poller
Built the first version of `anon_ticket_monitor`: it now loads `BootstrapConfig`, connects to `SeaOrmStorage`, polls `monero-wallet-rpc/get_transfers`, validates PID format, inserts payments, and persists the last processed height so restarts resume safely. Added a lightweight JSON-RPC client module, reqwest-based HTTP plumbing, tracing, and README/TODO updates documenting the service and completing MidTerm-6. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
edaac9a fix(monitor): index incoming transfers
Patched the monitor RPC call to request `in` transfers (and deserialize them) so the loop now processes both inbound and outbound entries, ensuring customer payments are persisted instead of silently ignored. The run loop chains the two vectors before inserting payments, preserving height tracking. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all` and `cargo clippy --workspace --all-features -- -D warnings`.
c5ec4e1 fix(monitor): persist max scanned height
Updated the monitor loop to track the maximum block height observed in each `get_transfers` batch and persist it once per batch. This prevents outgoing transfers with lower heights from regressing the stored cursor, ensuring the service continues making forward progress instead of reprocessing old blocks. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
a27beb9 feat(cache): add pid cache abstraction
Added `PidCache` + `InMemoryPidCache` to `anon_ticket_domain`, integrated it with the Actix API so negative lookups are memoized and successful claims mark PIDs as present. README now documents the cache behavior and TODO MidTerm-7 is complete. Tests cover the cache module and existing API integration continues to pass. Verified via `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
3f24251 fix(cache): never block storage lookups
Removed the negative-cache gate in `redeem_handler` so PIDs are always rechecked against storage, preventing "NotFound" entries from permanently poisoning legitimate redemptions before the monitor imports their payments. The cache now only records observations after a storage lookup (success, claimed, or absent). Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
200c400 feat(api): add token introspection and revocation
Implemented `GET /api/v1/token/{token}` and `POST /api/v1/token/{token}/revoke`, including domain-backed `TokenStatusResponse`, revoke requests, and integration tests that cover active, missing, and revocation scenarios. AppState now wires in the PID cache alongside the storage handle, and README/TODO document the new APIs (closing MidTerm-8). Validated with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
2973e1a fix(monitor): advance height for non pid entries
Adjusted the monitor loop to track the highest block height observed in each RPC batch even when no PID-qualified transfer is processed, so a block full of unrelated transfers no longer stalls progress. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
38dcbc1 fix(config): isolate api bootstrap env vars
Extracted a dedicated `ApiConfig` from the domain crate so the Actix server only validates `DATABASE_URL` and `API_BIND_ADDRESS`, leaving the monitor-specific Monero RPC knobs in `BootstrapConfig`. Updated the API binary to load the new helper, tightened the config test suite with a mutex guard to prevent env races, and refreshed the README guidance so operators know which services require which variables. Verified with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
8585236 feat(observability): add shared telemetry and abuse tracking
Introduced a reusable `telemetry` module in the domain crate that wires `tracing-subscriber` + Prometheus metrics with optional HTTP listeners and an `AbuseTracker`, then plumbed it through the API (PID abuse counters, `/metrics` route, request outcome counters) and monitor (RPC success/failure gauges, ingestion metrics). Workspace manifests and crate-level `Cargo.toml` files now pull in `metrics`, `metrics-exporter-prometheus`, and `once_cell`, `.env.example`/README/TODO describe the new knobs, and tests were rerun via `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, `cargo test --all --all-features` to keep CI parity.
b84f523 fix(telemetry): treat empty metrics address as unset
Addressed the regression where `TelemetryConfig::from_env` persisted blank `*_METRICS_ADDRESS` values and caused `init_telemetry` to fail by trimming env input and dropping empty strings before parsing socket addresses. Added a focused unit test to lock in the behavior while keeping the existing mutex guard to avoid env races, then re-ran `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` to ensure the metrics opt-in flow works with the default `.env` template.
fe8cae5 fix(monitor): avoid double tracing initialization
Removed the redundant `tracing_subscriber::fmt::init()` call inside `run()` because `init_telemetry` already installs the global subscriber; keeping both triggered `SetGlobalDefaultError` and crashed the monitor on startup. Verified the fix with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` so telemetry remains the single entry point for logging/metrics.
512f79e fix(api): recover service tokens for claimed payments
Made the redeem endpoint idempotent: when a PID is already claimed the handler now re-derives the deterministic token, ensures the `service_tokens` row exists, and returns the token instead of surfacing `409 Conflict`. The happy path now records tokens via their actual claimed timestamp, metrics distinguish recovered claims, README documents the behavior, and the duplicate-claim test asserts a 200 response with the original token. Verified with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
2b8c509 fix(api): make token recovery idempotent
Hardened the `ensure_token_record` helper so that when a claimed PID is retried concurrently it catches unique violations from `insert_token`, re-reads the existing deterministic token, and returns it, keeping the `already_claimed` path consistent with the documented behavior. `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` confirm the API now handles double-submit races without 500s.
65e819b fix(monitor): persist next height and read pid cache
Updated the monitor loop to only advance the stored cursor when at least one transfer is ingested and to persist `max_height + 1`, preventing repeated processing of the most recent block when the chain is idle. On the API side, `redeem_handler` finally checks the PID cache before querying storage and a new integration test proves the negative cache short-circuits to 404 immediately. Verified with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` to ensure both binaries exhibit the expected behavior.
4eeb0a1 fix(monitor): only ingest incoming transfers
Updated the monitor RPC request to drop `out` transfers and limit ingestion to `incoming` entries, preventing wallet spends from being misinterpreted as claimable deposits. The response struct no longer carries an unused `out` field, so the JSON parsing matches the new behavior. `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` confirm the binary still builds and operates as expected.
8667ccf fix(monitor): persist cursor even without new transfers
Adjusted the monitor loop so it always writes `last_processed_height` based on the highest block returned—even when no qualifying payments were inserted—ensuring restarts resume from the last scanned block instead of rewinding to the prior payment. Verified with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
dcf0eb0 fix(cache): add ttl to pid cache
Implemented TTL-backed negative caching in `InMemoryPidCache` (defaults to 60s with a `new(ttl)` helper) so transient 404s no longer permanently block legitimate redemptions. The monitor now only advances its scan cursor when it actually observes transfer heights or queries `get_height`, preventing idle periods from skipping real deposits. Verified with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
9eac460 chore(ci): add cargo deny license check
Added a `deny.toml` configuration that restricts dependencies to permissive/commercial-friendly licenses and clarifies `ring`/`webpki` metadata, then wired a GitHub Actions workflow that runs `cargo deny check licenses` on every push/PR to `main` plus a daily cron + manual trigger. This keeps the dependency tree continuously vetted for license regressions so the project remains safe for closed-source commercial use.
f1b97e9 chore(licenses): relax cargo deny config
Cleaned up `deny.toml` to match the latest cargo-deny schema and explicitly allow the OpenSSL/Unicode-3.0 family used by transitive TLS + ICU crates, making the license gate practical for the current dependency graph. `cargo deny check licenses` now passes locally while still blocking copyleft additions.
a37231a feat(api): add unix and internal listeners
Extended `ApiConfig`/.env so the HTTP API can bind to Unix sockets (`API_UNIX_SOCKET`) and optional internal-only listeners (`API_INTERNAL_BIND_ADDRESS` or `API_INTERNAL_UNIX_SOCKET`). The server now prefers UDS when configured, auto-cleans stale sockets, and spins up a second listener for internal routes like `/metrics` while keeping a TCP fallback. README documents the new env vars, the cache gained TTL semantics, and the test suite covers config loading plus socket cleanup. Verified via `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, `cargo test --all --all-features`, and `cargo deny check licenses`.
59ebb17 fix(api): recheck cached-negative pids
Addressed the review finding that negative PID cache entries blocked redemption for the full TTL by letting `redeem_handler` treat them as hints instead of an authoritative gate and emitting a dedicated cache metric rather than short-circuiting to 404. Added an Actix test that marks a PID absent, inserts the payment afterward, and proves redemption still succeeds so clients who probe early can claim as soon as storage records the transfer. Verified the patch with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, `cargo test --all --all-features`, and `cargo deny check licenses`.
e866883 fix(monitor): support unauthenticated rpc endpoints
Documented and implemented optional Monero wallet credentials so deployments that front a trusted RPC endpoint can omit HTTP Basic Auth entirely. `BootstrapConfig` now keeps `MONERO_RPC_USER/PASS` as `Option` and exposes tests covering unset as well as blank values to lock down the contract, while the monitor routes every request builder through a helper that only injects `Authorization` when credentials exist. README’s monitor section spells out the new env expectations, and the full fmt/clippy/test loop guards against regressions while leaving room to add token-protected RPCs later if abuse surfaces.
843e7fc docs(monitor): document watch-only wallet workflow
Extended the monitor section of README with a step-by-step guide for running monero-wallet-rpc against a hardware-backed watch-only wallet so every deployment keeps spend keys offline by default. The doc covers exporting address/view key, generating the watch-only wallet with a restore height, launching rpc with optional HTTP Basic Auth, and wiring MONERO_RPC_URL/MONITOR_START_HEIGHT, then explains why this topology should be the baseline operating model. Validated formatting-only change with the usual fmt/clippy/test loop to ensure no drift in the workspace.
557c740 fix(domain): canonicalize payment ids
Normalized every PaymentId constructor/parse path so the string is lowercased once and stored in a canonical form, closing the regression where monitor ingested lowercase RPC data but the API accepted uppercase input that never matched. Added explicit tests that uppercase values are normalized both via `PaymentId::parse` and `PaymentId::new`, ensuring storage, monitor, API, and token derivation stay case-insensitive without losing entropy. Verified via `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
abed757 fix(api): enforce pid cache short-circuit
Operationalized the negative PID cache by teaching `redeem_handler` to bail out before hitting storage whenever `PidCache::might_contain` returns false, logging cache hints and escalating abuse metrics at the edge. Added a TTL-aware helper plus two Actix tests that prove requests are blocked while an entry is cached and retried successfully once the TTL expires, updated README to explain the 60s default, and introduced an env override so unit tests can skip `.env` hydration. Suite validated with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` despite the known `sqlx-postgres` future-incompat warning.
7127ada fix(api): add grace window for pid cache
Backed the PID cache short-circuit with a 500ms grace window by extending the cache trait to expose negative entry age and only blocking requests while that window is fresh; afterwards the handler re-validates against storage even though the TTL hasn’t expired. README documents the behavior, metrics labels distinguish blocked vs probed misses, and a new Actix test proves that requests succeed after the grace period while existing TTL-based expiry coverage remains. Verified via `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` (future-incompat warning still emanates from `sqlx-postgres 0.7.4`).
REVIEW fix/monitor-dotenv-guard
Reviewer reported that `anon_ticket_monitor` bypasses the new `ANON_TICKET_SKIP_DOTENV` guard by invoking `dotenvy::dotenv()` before `BootstrapConfig::load_from_env`, so production deployments cannot disable `.env` hydration; this branch will remove the redundant call and rely fully on the shared config loader. Also tasked with ensuring future commits keep config interactions consistent across binaries.
