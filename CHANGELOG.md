1a571bf6 chore(repo): add workspace gitignore
Established a baseline `.gitignore` that covers Cargo builds, wasm-pack artifacts, IDE clutter, and local configuration in order to keep future Rust worktree clean despite the current minimal file set. Documented why several project-specific paths (matrix bot configs, proto outputs, drafts) remain untracked so contributors know where to place sensitive data without risking accidental commits. Highlighted the intent to pair every public English log with a private Chinese mirror while keeping the mirror ignored so bi-lingual context is preserved locally without polluting history; future entries should follow the same diary style.
af31d54 docs(todo): seed project roadmap
Outlined a tiered roadmap in `TODO.md` that bridges the high-level blueprint from `drafts/dev.md` with concrete, test-first tasks. Prioritized workspace scaffolding and deterministic environment setup as immediate items so later crates inherit consistent tooling, then layered storage, validation, API, monitor, caching, and observability milestones with explicit testing (sqlx integration, Actix HTTP harnesses, property tests) and documentation requirements (README sections, module docs, architecture notes). The checklist also encodes risk callouts—like trait abstraction churn, RPC availability, and cache DoS potential—to keep future contributors aware while enabling modular backends (SQLite now, Redis/moka later).
2702e1a feat(workspace): bootstrap cargo workspace
Stood up the multi-crate workspace with resolver 2, shared package metadata, and lint/format configs so every crate inherits the same rules. Added placeholder API/monitor binaries plus a domain crate that exposes `workspace_ready_message`, wiring the binaries through it to prove dependencies compile end-to-end. Documented the workspace layout/commands in `README.md`, ticked the Immediate-1 entry in `TODO.md`, and validated the scaffold by running `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` from the root.
dbfc2f0 feat(env): add deterministic config plumbing
Pinned the toolchain via `rust-toolchain.toml`, introduced `.env.example`, and documented the `config/` secrets workflow so every crate consumes the same deterministic environment. Extended the workspace manifest with shared `dotenvy`/`sha3`/`hex`/`thiserror` deps, taught the domain crate to expose `BootstrapConfig`, `ConfigError`, and a SHA3-256 PID fingerprint helper, and updated the API + monitor binaries to call those routines. README now explains the environment setup, TODO reflects Immediate-2 completion, and `.gitignore` shields secrets while `config/README.md` captures expectations. Verified everything with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
1895cbe chore(toolchain): bump rust to 1.91.1
Upgraded the workspace to Rust 1.91.1 via `rust-toolchain.toml` and reflected the change in README so contributors install the latest stable toolchain. Verified compatibility by running `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` on the new release.
6dcb33c feat(storage): add seaorm repository layer
Introduced the trait-based storage contracts in `anon_ticket_domain::storage` (PID/service token newtypes, storage errors, async traits) and wired them into the new `anon_ticket_storage` crate. The SeaORM adapter now runs schema migrations for SQLite/optional Postgres, offers a single `SeaOrmStorage::connect` helper, and ships integration tests that exercise payment claiming, token issuance/revocation, and monitor height persistence. README documents how to toggle between SQLite and Postgres features, and the ShortTerm-3 TODO item is checked off to reflect the completed storage milestone.
a992d88 fix(storage): atomically guard payment claims
Hardened `SeaOrmStorage::claim_payment` so that it performs a single atomic `UPDATE ... WHERE status = 'unclaimed'` before reading back the row, preventing concurrent claimers from double-spending the same PID. Added a regression test that launches two async claimers and asserts only one succeeds, ensuring the guard works under real concurrency. Verified the change with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
da571d8 fix(storage): gate tests per backend feature
Adjusted the `anon_ticket_storage` test suite to respect whichever SeaORM backend feature is enabled: SQLite runs against the in-memory DSN, while Postgres relies on a `TEST_POSTGRES_URL` env var, and unsupported combos skip tests with a clear message. README now explains how to set that env var before using the documented Postgres command. Validated the change with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
02f3e77 feat(domain): add pid validation and token helpers
Introduced `validate_pid`, `PaymentId::parse`, and `derive_service_token` so every crate can enforce the 32-character hex PID contract and derive SHA3-based service tokens consistently. The helpers ship unit tests that check invalid inputs, parsing, and deterministic outputs, plus README guidance encouraging callers to use the new APIs. Also ticked ShortTerm-4 in TODO.md to reflect the completed milestone. Validated via `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
1e76921 chore(domain): format pid validation test
Lightly reformatted the `pid_validation_rejects_invalid_inputs` assertion so the long hex string comparison is multi-line and easier to diff/scan during future edits. No behavior change, but keeps the growing domain helper tests consistent with rustfmt output.
7c44143 fix(storage): make payment insert idempotent
Reworked `SeaOrmStorage::insert_payment` to issue a single `INSERT ... ON CONFLICT DO NOTHING` via `exec_without_returning`, so duplicate PID inserts succeed instead of raising unique constraint errors under concurrent monitor tasks. Added a regression test (`inserting_same_pid_twice_is_ok`) to ensure the helper remains side-effect free when called twice. Validated with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
740fdfd feat(api): add redeem endpoint
Implemented the first Actix-Web surface for `POST /api/v1/redeem`: it validates PID format via the shared domain helpers, atomically claims payments through `SeaOrmStorage`, derives deterministic service tokens, and emits structured JSON success/ error responses (404, 409, etc.). Added an `AppState` wiring to BootstrapConfig + SeaORM in `main`, plus README docs covering request/response contracts. Integration tests now spin up the handler on SQLite to cover invalid PID, missing payment, success, and duplicate claim scenarios. Ran `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.rustup-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
c4a6d8c feat(monitor): implement rpc poller
Built the first version of `anon_ticket_monitor`: it now loads `BootstrapConfig`, connects to `SeaOrmStorage`, polls `monero-wallet-rpc/get_transfers`, validates PID format, inserts payments, and persists the last processed height so restarts resume safely. Added a lightweight JSON-RPC client module, reqwest-based HTTP plumbing, tracing, and README/TODO updates documenting the service and completing MidTerm-6. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
edaac9a fix(monitor): index incoming transfers
Patched the monitor RPC call to request `in` transfers (and deserialize them) so the loop now processes both inbound and outbound entries, ensuring customer payments are persisted instead of silently ignored. The run loop chains the two vectors before inserting payments, preserving height tracking. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all` and `cargo clippy --workspace --all-features -- -D warnings`.
c5ec4e1 fix(monitor): persist max scanned height
Updated the monitor loop to track the maximum block height observed in each `get_transfers` batch and persist it once per batch. This prevents outgoing transfers with lower heights from regressing the stored cursor, ensuring the service continues making forward progress instead of reprocessing old blocks. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
a27beb9 feat(cache): add pid cache abstraction
Added `PidCache` + `InMemoryPidCache` to `anon_ticket_domain`, integrated it with the Actix API so negative lookups are memoized and successful claims mark PIDs as present. README now documents the cache behavior and TODO MidTerm-7 is complete. Tests cover the cache module and existing API integration continues to pass. Verified via `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
3f24251 fix(cache): never block storage lookups
Removed the negative-cache gate in `redeem_handler` so PIDs are always rechecked against storage, preventing "NotFound" entries from permanently poisoning legitimate redemptions before the monitor imports their payments. The cache now only records observations after a storage lookup (success, claimed, or absent). Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
200c400 feat(api): add token introspection and revocation
Implemented `GET /api/v1/token/{token}` and `POST /api/v1/token/{token}/revoke`, including domain-backed `TokenStatusResponse`, revoke requests, and integration tests that cover active, missing, and revocation scenarios. AppState now wires in the PID cache alongside the storage handle, and README/TODO document the new APIs (closing MidTerm-8). Validated with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
2973e1a fix(monitor): advance height for non pid entries
Adjusted the monitor loop to track the highest block height observed in each RPC batch even when no PID-qualified transfer is processed, so a block full of unrelated transfers no longer stalls progress. Verified with `CARGO_HOME=$PWD/.cargo-local RUSTUP_HOME=$PWD/.cargo-local cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
38dcbc1 fix(config): isolate api bootstrap env vars
Extracted a dedicated `ApiConfig` from the domain crate so the Actix server only validates `DATABASE_URL` and `API_BIND_ADDRESS`, leaving the monitor-specific Monero RPC knobs in `BootstrapConfig`. Updated the API binary to load the new helper, tightened the config test suite with a mutex guard to prevent env races, and refreshed the README guidance so operators know which services require which variables. Verified with `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features`.
8585236 feat(observability): add shared telemetry and abuse tracking
Introduced a reusable `telemetry` module in the domain crate that wires `tracing-subscriber` + Prometheus metrics with optional HTTP listeners and an `AbuseTracker`, then plumbed it through the API (PID abuse counters, `/metrics` route, request outcome counters) and monitor (RPC success/failure gauges, ingestion metrics). Workspace manifests and crate-level `Cargo.toml` files now pull in `metrics`, `metrics-exporter-prometheus`, and `once_cell`, `.env.example`/README/TODO describe the new knobs, and tests were rerun via `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, `cargo test --all --all-features` to keep CI parity.
b84f523 fix(telemetry): treat empty metrics address as unset
Addressed the regression where `TelemetryConfig::from_env` persisted blank `*_METRICS_ADDRESS` values and caused `init_telemetry` to fail by trimming env input and dropping empty strings before parsing socket addresses. Added a focused unit test to lock in the behavior while keeping the existing mutex guard to avoid env races, then re-ran `cargo fmt --all`, `cargo clippy --workspace --all-features -- -D warnings`, and `cargo test --all --all-features` to ensure the metrics opt-in flow works with the default `.env` template.
