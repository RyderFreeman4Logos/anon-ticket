# TODO

## Pending
- [x] **Immediate-1** Bootstrap the Cargo workspace with root `Cargo.toml`, shared lint settings, and stub crates for API, monitor, and domain logic so that future work is cleanly modularized – Tests: add smoke `cargo test --all --all-features`/`cargo clippy --workspace --all-features` CI jobs plus unit tests ensuring each crate compiles with required features – Docs: expand `README.md` with the workspace layout diagram and command matrix, and inline crate-level `//!` docs describing responsibilities – Risks/Deps: selecting crate boundaries too early could cause churn; capture assumptions in `design_docs/` for review.
- [x] **Immediate-2** Establish deterministic environment plumbing (Rust toolchain pin, `.env.example`, sample `config/` secrets flow) and wire up `sha3` + `dotenvy` crates across workspace to keep hashing and configuration consistent – Tests: add config parsing unit tests plus a `cargo test` guard verifying `.env` loading from fixtures – Docs: document environment variables in README tables and annotate `.env.example` – Risks/Deps: ensure secrets are never committed by extending `.gitignore` and adding a pre-commit note.
- [x] **ShortTerm-3** Define the storage abstraction layer (`PaymentStore`, `TokenStore`, `MonitorStateStore`) and deliver the initial SQLite-backed adapter covering migrations and connection pooling – Tests: use `sqlx::test` or TempDir-backed integration tests to exercise CRUD flows and transactional guarantees – Docs: generate module-level docs explaining trait contracts and add migration walkthroughs to README – Risks/Deps: confirm `sqlx` offline data is checked in to keep CI deterministic.
- [x] **ShortTerm-4** Implement the PID validation and token derivation helpers (enforcing 32-char hex + SHA3-256) as a shared domain module to guarantee all components apply identical security checks – Tests: property tests ensuring invalid PIDs are rejected plus unit tests comparing hash outputs to vectors – Docs: add `///` docs with examples and update README security model section – Risks/Deps: highlight entropy requirements to avoid weak client implementations.
- [x] **ShortTerm-5** Build the Actix `POST /api/v1/redeem` endpoint that uses the storage trait for atomic claim updates and emits deterministic service tokens – Tests: request-level integration tests (Actix test server) that cover success, duplicate, and invalid PID paths – Docs: extend API reference in README (request/response schemas) and include tracing annotations in code comments – Risks/Deps: ensure DB transactions roll back on network failures; add error taxonomy upfront.
- [x] **MidTerm-6** Ship the monitor service crate that tails `monero-wallet-rpc`, persists qualifying transfers through the storage trait, and tracks height via `MonitorStateStore` without hardcoded defaults – Tests: async integration tests with mocked RPC responses plus regression tests for resume-from-height – Docs: architecture note in `docs/` describing polling cadence and failure recovery – Risks/Deps: requires RPC endpoint availability; design retry/backoff strategy.
- [x] **MidTerm-7** Introduce the caching/bloom-filter abstraction (trait-based) with an in-memory MVP to screen obvious invalid PIDs before hitting storage, paving the way for moka/Redis implementations – Tests: unit tests covering false-positive bounds and eviction plus integration tests verifying cache bypass falls back to DB – Docs: README section comparing cache strategies and inline notes on tuning false-positive rates – Risks/Deps: guard against cache becoming DoS vector by specifying quotas.
- [x] **MidTerm-8** Provide introspection and revocation APIs (`GET /api/v1/token/{token}`, `POST /api/v1/token/{token}/revoke`) backed by the token store with auditing fields populated – Tests: HTTP integration tests covering active, revoked, and missing tokens along with auth failure permutations – Docs: document operational playbooks for revocation and add OpenAPI snippets – Risks/Deps: define auth story (mTLS or static keys) before exposing endpoints.
- [x] **LongTerm-9** Layer in observability and abuse detection (structured tracing, metrics, abuse score escalation, dashboarding hooks) so production deployments can detect DoS or misuse early – Tests: telemetry snapshot tests plus load-test scripts to validate metrics fidelity – Docs: operations guide covering alert thresholds and tracing conventions – Risks/Deps: depends on earlier API + monitor milestones; coordinate with infra for metrics backend.
- [x] **ShortTerm-10** Add Unix socket support for the public API listener (env-driven `API_UNIX_SOCKET`, auto-clean stale sockets, fallback to TCP bind) – Tests: Actix integration tests exercising socket + TCP modes – Docs: README/.env documenting the behavior and deployment tips – Risks/Deps: file permissions/cleanup errors or SELinux/AppArmor policies blocking socket creation.
- [x] **ShortTerm-11** Introduce an internal-only API listener (dedicated port or Unix socket) for admin/monitoring routes so Tor-exposed endpoints stay minimal – Tests: ensure internal routes reject external traffic and cover dual-listener wiring – Docs: configuration guidance describing how to bind internal interfaces and enforce permissions – Risks/Deps: added config complexity; need to clearly separate auth for internal vs public endpoints.
- [x] **ShortTerm-12** Refactor `anon_ticket_domain` into cohesive modules (`config.rs`, `model/`, `services/`, `storage/traits.rs`) so binaries import narrowly-scoped APIs and doc comments reflect the new boundaries – Tests: rerun existing unit/property suites plus add module-specific doctests documenting the new paths – Docs: update crate-level `//!` docs and README “Workspace Layout” to show internal submodules – Risks/Deps: requires careful move semantics to avoid breaking downstream imports; coordinate with open PRs touching domain helpers.
- [x] **ShortTerm-13** Split the API crate into `handlers/`, `state.rs`, and `application.rs` so HTTP wiring, request handling, and bootstrap logic can evolve independently – Tests: keep current Actix integration tests passing and add handler-level unit tests using `App::new()` scaffolds – Docs: extend README “Redemption API” to mention new module boundaries and note how to embed the server in other binaries – Risks/Deps: heavy file moves may invalidate pending branches; schedule work during low churn windows.
- [ ] **MidTerm-14** Decompose the monitor crate into RPC client, ingestion pipeline, and worker loop modules while introducing a trait-based transfer source for easier simulation – Tests: add mocked transfer-source tests plus regression coverage for height advancement/backoff; keep long-running `tokio::test` gated – Docs: produce a short architecture note (and README summary) describing the data flow – Risks/Deps: more traits mean stricter lifetime/Send bounds; ensure reqwest client reuse stays efficient.
- [ ] **MidTerm-15** Break `anon_ticket_storage` into per-trait impl files (`payment_store.rs`, `token_store.rs`, `monitor_state_store.rs`, `migration.rs`) and add a thin builder for injecting caching/sharding later – Tests: rerun sqlite/postgres integration tests and add targeted unit tests for the builder defaults – Docs: update README “Storage Layer” to explain the builder plus migration split – Risks/Deps: SeaORM entity paths change, so regenerate docs/tests referencing old modules.

## Plan Summary
Foundational scaffolding, storage correctness, and API/monitor surfaces are in place; upcoming work focuses on richer observability plus network-surface hardening (Unix socket listeners, internal-only admin surfaces) while keeping unit/property tests, sqlx-backed integration tests, and Actix HTTP tests green. Documentation now highlights environment knobs, metrics scraping paths, and listener configuration so future contributors can extend modules confidently.
